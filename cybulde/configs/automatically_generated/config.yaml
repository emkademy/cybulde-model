# Do not edit this file. It is automatically generated by cybulde/generate_final_config.py.
# If you want to modify configuration, edit source files in cybulde/configs directory.

defaults:
- override hydra/hydra_logging: disabled
- _self_
hydra:
  output_subdir: null
  run:
    dir: .

infrastructure:
  project_id: cybulde
  zone: europe-west4-a
  instance_group_creator:
    _target_: cybulde.infrastructure.instance_group_creator.InstanceGroupCreator
    instance_template_creator:
      _target_: cybulde.infrastructure.instance_template_creator.InstanceTemplateCreator
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
      - https://www.googleapis.com/auth/cloud.useraccounts.readonly
      - https://www.googleapis.com/auth/cloudruntimeconfig
      network: https://www.googleapis.com/compute/v1/projects/cybulde/global/networks/default
      subnetwork: https://www.googleapis.com/compute/v1/projects/cybulde/regions/europe-west4/subnetworks/default
      startup_script_path: scripts/vm_startup/task_runner_startup_script.sh
      vm_config:
        machine_type: n1-standard-8
        accelerator_count: 1
        accelerator_type: nvidia-tesla-t4
        vm_type: STANDARD
        disks: []
      boot_disk_config:
        project_id: deeplearning-platform-release
        name: common-cu113-v20230925
        size_gb: 50
        labels:
          project: cybulde
      vm_metadata_config:
        instance_group_name: Default-None-20231029103044
        docker_image: europe-west4-docker.pkg.dev/cybulde/cybulde/cybulde-model:train-eaa1426e-2dab-4b66-a0d3-4e55cabe673e
        zone: europe-west4-a
        python_hash_seed: 42
        mlflow_tracking_uri: http://cybulde-mlflow.europe-west4-a.c.cybulde.internal:6100
        node_count: 1
        disks: []
      template_name: Default-None-20231029103044
      project_id: cybulde
      labels:
        project: cybulde
    name: Default-None-20231029103044
    node_count: 1
    project_id: cybulde
    zone: europe-west4-a
  mlflow:
    mlflow_external_tracking_uri: http://localhost:6100
    mlflow_internal_tracking_uri: http://cybulde-mlflow.europe-west4-a.c.cybulde.internal:6100
    experiment_name: Default
    run_name: null
    run_id: 180aa022719c4e9fa78bed15c7cc58fd
    experiment_id: '0'
    experiment_url: http://localhost:6100/#/experiments/0/runs/180aa022719c4e9fa78bed15c7cc58fd
    artifact_uri: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts
save_last_checkpoint_every_n_train_steps: 500
seed: 1234
tasks:
  binary_text_classification_task:
    _target_: cybulde.training.tasks.tar_model_exporting_training_task.TarModelExportingTrainingTask
    name: binary_text_classfication_task
    data_module:
      _target_: cybulde.data_modules.data_modules.TextClassificationDataModule
      batch_size: 64
      shuffle: false
      num_workers: 8
      pin_memory: true
      drop_last: true
      persistent_workers: false
      train_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/train.parquet
      dev_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/dev.parquet
      test_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/test.parquet
      transformation:
        _target_: cybulde.models.transformations.HuggingFaceTokenizationTransformation
        pretrained_tokenizer_name_or_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/trained_tokenizer
        max_sequence_length: 100
      text_column_name: cleaned_text
      label_column_name: label
    lightning_module:
      _target_: cybulde.training.lightning_modules.binary_text_classification.BinaryTextClassificationTrainingLightningModule
      model:
        _target_: cybulde.models.models.BinaryTextClassificationModel
        backbone:
          _target_: cybulde.models.backbones.HuggingFaceBackbone
          transformation:
            _target_: cybulde.models.transformations.HuggingFaceTokenizationTransformation
            pretrained_tokenizer_name_or_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/trained_tokenizer
            max_sequence_length: 100
          pretrained_model_name_or_path: prajjwal1/bert-tiny
          pretrained: false
        adapter:
          _target_: cybulde.models.adapters.MLPWithPooling
          output_feature_sizes:
          - -1
          biases: null
          activation_fns: null
          dropout_drop_probs: null
          batch_norms: null
          order: LABDN
          standardize_input: true
          pooling_method: null
          output_attribute_to_use: pooler_output
        head:
          _target_: cybulde.models.heads.SigmoidHead
          in_features: 128
          out_features: 1
      loss:
        _target_: cybulde.training.loss_functions.BCEWithLogitsLoss
        reduction: mean
      optimizer:
        _target_: torch.optim.AdamW
        _partial_: true
        lr: 0.005
        betas:
        - 0.9
        - 0.999
        eps: 1.0e-08
        weight_decay: 0.0
        amsgrad: false
        foreach: null
        maximize: false
        capturable: false
      scheduler:
        _target_: cybulde.training.schedulers.CommonLightningScheduler
        scheduler:
          _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
          _partial_: true
          mode: max
          factor: 0.1
          patience: 5
          threshold: 0.0001
          threshold_mode: rel
          cooldown: 0
          min_lr: 0.0
          eps: 1.0e-08
          verbose: false
        interval: epoch
        frequency: 1
        monitor: validation_f1_score
        strict: true
        name: null
    trainer:
      _target_: lightning.pytorch.trainer.trainer.Trainer
      accelerator: gpu
      strategy: ddp_find_unused_parameters_true
      devices: auto
      num_nodes: 1
      precision: 16-mixed
      logger:
      - _target_: lightning.pytorch.loggers.mlflow.MLFlowLogger
        experiment_name: Default
        run_name: null
        tracking_uri: http://cybulde-mlflow.europe-west4-a.c.cybulde.internal:6100
        tags: null
        save_dir: null
        prefix: ''
        artifact_location: null
        run_id: 180aa022719c4e9fa78bed15c7cc58fd
      callbacks:
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/best-checkpoints/
        filename: null
        monitor: validation_f1_score
        verbose: false
        save_last: true
        save_top_k: 2
        mode: max
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: null
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/last-checkpoints/
        filename: checkpoint-{epoch}
        monitor: null
        verbose: false
        save_last: true
        save_top_k: -1
        mode: min
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: 500
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.LearningRateMonitor
        logging_interval: step
      fast_dev_run: false
      max_epochs: 3
      min_epochs: null
      max_steps: -1
      min_steps: null
      max_time: null
      limit_train_batches: 0.01
      limit_val_batches: 0.01
      limit_test_batches: 0.01
      limit_predict_batches: 1.0
      overfit_batches: 0.0
      val_check_interval: 1.0
      check_val_every_n_epoch: 1
      num_sanity_val_steps: 2
      log_every_n_steps: 1
      enable_checkpointing: true
      enable_progress_bar: true
      enable_model_summary: true
      accumulate_grad_batches: 1
      gradient_clip_val: 5.0
      gradient_clip_algorithm: value
      deterministic: null
      benchmark: null
      inference_mode: true
      use_distributed_sampler: true
      detect_anomaly: false
      barebones: false
      sync_batchnorm: true
      reload_dataloaders_every_n_epochs: 0
      default_root_dir: ./data/pytorch-lightning
    best_training_checkpoint: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/best-checkpoints/last.ckpt
    last_training_checkpoint: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/last-checkpoints/last.ckpt
    tar_model_export_path: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/exported_model.tar.gz
  binary_text_evaluation_task:
    _target_: cybulde.evaluation.tasks.common_evaluation_task.CommonEvaluationTask
    name: binary_text_evaluation_task
    data_module:
      _target_: cybulde.data_modules.data_modules.TextClassificationDataModule
      batch_size: 64
      shuffle: false
      num_workers: 8
      pin_memory: true
      drop_last: true
      persistent_workers: false
      train_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/train.parquet
      dev_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/dev.parquet
      test_df_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/test.parquet
      transformation:
        _target_: cybulde.models.transformations.HuggingFaceTokenizationTransformation
        pretrained_tokenizer_name_or_path: gs://emkademy/cybulde/data/processed/rebalanced_splits/trained_tokenizer
        max_sequence_length: 100
      text_column_name: cleaned_text
      label_column_name: label
    lightning_module:
      _target_: cybulde.evaluation.lightning_modules.binary_text_evaluation.BinaryTextEvaluationLightningModule
      _partial_: true
    trainer:
      _target_: lightning.pytorch.trainer.trainer.Trainer
      accelerator: gpu
      strategy: ddp_find_unused_parameters_true
      devices: auto
      num_nodes: 1
      precision: 16-mixed
      logger:
      - _target_: lightning.pytorch.loggers.mlflow.MLFlowLogger
        experiment_name: Default
        run_name: null
        tracking_uri: http://cybulde-mlflow.europe-west4-a.c.cybulde.internal:6100
        tags: null
        save_dir: null
        prefix: ''
        artifact_location: null
        run_id: 180aa022719c4e9fa78bed15c7cc58fd
      callbacks:
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/best-checkpoints/
        filename: null
        monitor: validation_f1_score
        verbose: false
        save_last: true
        save_top_k: 2
        mode: max
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: null
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.ModelCheckpoint
        dirpath: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/last-checkpoints/
        filename: checkpoint-{epoch}
        monitor: null
        verbose: false
        save_last: true
        save_top_k: -1
        mode: min
        auto_insert_metric_name: false
        save_weights_only: false
        every_n_train_steps: 500
        train_time_interval: null
        every_n_epochs: null
        save_on_train_epoch_end: null
      - _target_: lightning.pytorch.callbacks.LearningRateMonitor
        logging_interval: step
      fast_dev_run: false
      max_epochs: 3
      min_epochs: null
      max_steps: -1
      min_steps: null
      max_time: null
      limit_train_batches: 0.01
      limit_val_batches: 0.01
      limit_test_batches: 0.01
      limit_predict_batches: 1.0
      overfit_batches: 0.0
      val_check_interval: 1.0
      check_val_every_n_epoch: 1
      num_sanity_val_steps: 2
      log_every_n_steps: 1
      enable_checkpointing: true
      enable_progress_bar: true
      enable_model_summary: true
      accumulate_grad_batches: 1
      gradient_clip_val: 5.0
      gradient_clip_algorithm: value
      deterministic: null
      benchmark: null
      inference_mode: true
      use_distributed_sampler: true
      detect_anomaly: false
      barebones: false
      sync_batchnorm: true
      reload_dataloaders_every_n_epochs: 0
      default_root_dir: ./data/pytorch-lightning
    tar_model_path: gs://emkademy-mlflow/0/180aa022719c4e9fa78bed15c7cc58fd/artifacts/exported_model.tar.gz
model_selector:
  _target_: cybulde.evaluation.model_selector.ModelSelector
  mlflow_run_id: 180aa022719c4e9fa78bed15c7cc58fd
  must_be_better_metric_comparers:
    f1_score:
      _target_: cybulde.evaluation.model_selector.MetricComparer
      bigger_is_better: true
      can_be_equal: false
      metric_name: test_f1_score
      threshold: 0.0
    model_size:
      _target_: cybulde.evaluation.model_selector.MetricComparer
      bigger_is_better: false
      can_be_equal: true
      metric_name: model_size
      threshold: 0.0
  to_be_thresholded_metric_comparers: {}
  threshold: 0.0
registered_model_name: bert_tiny
